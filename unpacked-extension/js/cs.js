/**
 * @author Sven Ackermann (svenrecknagel@gmail.com)
 * @license BSD license
 */
$(function(){function t(t,e){Q&&Q.postMessage({type:t,value:e})}function e(t){return encodeURIComponent($.trim(t)).replace(/(%20)+/g,"+")}function i(t){return t&&decodeURIComponent(t.replace(/(\+)+/g,"%20"))}function n(t){var e=location.hash.substr(2);return e==t||decodeURIComponent(e)==t}function a(t,e){return t.data("id")?t.data("type")+"/"+t.data("id"):e?t.data("type"):null}function r(t){var e=t.attr("src");return e&&e.indexOf("/default_album_med.png")>0?null:(e&&0===e.indexOf("//")&&(e="https:"+e),e)}function s(t){if(t){var e=parseInt(t.dataset.rating);return isNaN(e)?0:e}return-1}function o(t,e){return!(t.title!=e.title||t.duration!=e.duration||t.artist&&e.artist&&t.artist!=e.artist)}function l(){c(),$("<div class='ppconnected'>").attr("title",mt("connected")).click(function(){Q.disconnect(),w()}).insertBefore("#material-breadcrumbs")}function c(){$(".ppconnected").remove()}function d(t,e,i){var n=$("#ppLyricsContainer");if(n.is(":visible")){n.removeClass("loading");var a=n.find("#ppLyricsContent"),r=n.find("#ppLyricsCredits");t.error?a.html("<div class='error'></div>"):t.noresults?a.html("<div class='empty'></div>"):(n.children("#ppLyricsTitle").children("div").text(t.title).attr("title",t.title),a.html(t.lyrics),t.credits&&r.html(t.credits+"<br/>")),r.append(mt("lyricsSrcProvider",i)),r.append("<br>"),t.src&&r.append($("<a target='_blank'></a>").attr("href",t.src).text(mt("lyricsSrc"))).append($("<br/>")),t.searchSrc&&r.append($("<a target='_blank'></a>").attr("href",t.searchSrc).text(mt("lyricsSearchResult"))),e=e||r.data("providers"),r.removeData("providers"),e.forEach(function(t){r.append("<br>"),$("<a>").text(mt("lyricsSearchProvider",t.url)).click(function(){var i=e.slice();i.splice(i.indexOf(t),1),r.data("providers",i),u(t.provider)}).appendTo(r)})}}function u(e){$("#ppLyricsTitle").children("div").removeAttr("title").empty(),$("#ppLyricsContent").empty(),$("#ppLyricsCredits").empty(),$("#ppLyricsContainer").addClass("loading").show(),t("loadLyrics",e)}function f(){var t=$("#ppLyricsContainer").width()+10;$("#mainPanel").css({width:$("#content-container").width()-t+"px",left:t+"px"})}function p(){$(window).off("resize",f),$("#mainPanel").css("width","").css("left","")}function m(){var t=$("#ppLyricsContainer");t.is(":visible")?(t.removeClass().hide(),p()):$(this).hasClass("active")&&(u(),$(window).on("resize",f),f())}function v(){$("#ppLyricsButton, #ppLyricsContainer").remove(),p()}function h(t,e,i){$("#ppLyricsButton").length||($("<img id='ppLyricsButton'/>").attr("src",vt("img/cmd/openLyrics.png")).attr("title",mt("command_openLyrics")).toggleClass("active",!!$("#currently-playing-title").length).click(m).appendTo("#material-player-right-wrapper"),$("<div id='ppLyricsContainer'><div id='ppLyricsTitle'><a class='reloadLyrics'></a><div></div></div><div id='ppLyricsScroller'><div id='ppLyricsContent'></div><div id='ppLyricsCredits'></div></div></div>").on("click",".reloadLyrics",u.bind(window,null)).css({bottom:$("#player").height()+5+"px",top:$("#material-app-bar").height()+5+"px"}).appendTo("body")),$("#ppLyricsContainer").css({"font-size":t+"px",width:e,opacity:i}),$("#ppLyricsContainer").is(":visible")&&f()}function g(t){ct=t,dt=-1,t?$("#queueContainer").on("DOMSubtreeModified",".song-row.currently-playing [data-col='rating']",O):$("#queueContainer").off("DOMSubtreeModified",O),O()}function y(){if(it)return mt("musicIsPlaying")}function b(t){$(window).off("beforeunload",y),t&&$(window).on("beforeunload",y)}function w(){T("cleanup"),window.removeEventListener("message",E),$("#primeplayerinjected").remove(),$("#music-content,#queueContainer").off("DOMSubtreeModified mouseup"),$("#playerSongInfo").off("click"),$(window).off("hashchange"),b(!1),st.forEach(function(t){t.disconnect()}),c(),v(),Q=null,g(!1)}function x(t){var e=t.closest(".cluster");return e.length?e.parent().children(".cluster").index(e)+1:0}function L(t){return function(){var e=$(this).closest(ft);return!e.length||e[0]==t[0]}}function C(t){var n=$("#playerSongInfo");if(n.is(":visible")&&n.find("div").length){var s=$("#player-artist"),o=n.find(".player-album"),l=o.data("id"),c={artist:$.trim(s.text()),title:$.trim($("#currently-playing-title").text()),album:$.trim(o.text()),albumArtist:l&&i(l.split("/")[1]),duration:$.trim($("#time_container_duration").text())};if(t){c.artistLink=a(s)||"artist//"+e(c.artist),c.albumLink=a(o),c.cover=r($("#playerBarArt"));var d=$(".song-row.currently-playing");d[0]&&(c.playlist=location.hash.substr(2),c.index=d.data("index"),c.cluster=x(d))}return c}return null}function k(t){return!$(t).find("iron-icon>svg>g").attr("transform")}function O(){var e=$("#playerSongInfo .rating-container"),i=-1;if(e[0])if(ct){var n=$("#queueContainer .song-row.currently-playing");if(!n[0])return void F(pt,$.noop);i=s(n.children("[data-col='rating']")[0])}else i=0,e.children("[data-rating]").each(function(){if(k(this))return i=s(this),!1});dt!==i&&(dt=i,(X||J)&&$("#music-content,#queueContainer").find(".song-row td[data-col='rating']").trigger("DOMSubtreeModified"),t("song-rating",dt),ut>=0&&ut===dt&&t("rated",{song:C(),rating:dt}),ut=-1)}function S(){$("#playerSongInfo").length?M():(ht||(ht=!0,I(S)),setTimeout(S,250))}function M(){function e(t){t.source==window&&"FROM_PRIMEPLAYER"==t.data.type&&"cleanupCsDone"==t.data.msg&&(window.removeEventListener("message",e),S())}function i(){var e=C(!0);e&&lt&&$("#ppLyricsContainer").is(":visible")&&!o(e,nt)&&(clearTimeout(tt),tt=setTimeout(u,1e3)),nt=e,$("#ppLyricsButton").toggleClass("active",!!e),t("song-info",e)}function r(e){var i=$.trim(e.text());i!=et&&(et=i,t("song-position",et))}function l(t){var e=$(t);return void 0===e.attr("disabled")&&!e.hasClass("disabled")}function c(t){return it=l(t)?$(t).hasClass("playing"):null}function d(t){if(t=$(t),"none"!=t.css("display")&&l(t)){if(t.hasClass("active")){var e=t.find("path").attr("d");if(e)return e.length>64?"SINGLE_REPEAT":"LIST_REPEAT"}return"NO_REPEAT"}return""}function f(t){return t=$(t),"none"!=t.css("display")&&l(t)?t.hasClass("active")?"ALL_SHUFFLE":"NO_SHUFFLE":""}function p(){if(G==pt&&$.isFunction(V)){var t=V;V=null,G=null,t()}}function m(){if($.isFunction(V)){if(G&&!n(G))return;var t=V;V=null,G=null,t()}}function v(t,e,i,n){var a=$(e);if(a.length){var r;if(i){var s;r=function(){clearTimeout(s),s=setTimeout(function(){s=null,t(a)},i)}}else r=t.bind(window,a);var o=new MutationObserver(function(t){t.forEach(r)});st.push(o);var l={childList:!0,subtree:!0};n&&(l.attributes=!0,l.attributeFilter=n.split(" ")),o.observe(a[0],l),r()}}function h(e,i,n,a,r){var s=$(i);if(s.length){a=a||function(t,e){return t.getAttribute(e)};var o,l=a(s[0],e),c=new MutationObserver(function(e){e.forEach(function(e){function i(){var i=a(e.target,e.attributeName);i!==l&&(l=i,t(n,l))}clearTimeout(o),o=setTimeout(i,r||0)})});st.push(c),s.each(function(){c.observe(this,{attributes:!0,attributeFilter:e.split(" ")})}),t(n,l)}}function g(){if(!$("#loading-progress").is(":visible")){clearInterval(b);var e={};$("#nav_collections > *[data-type]").each(function(){e[$(this).data("type")]=$.trim($(this).text())}),$("#header-tabs-container .tab-container > *[data-type]").each(function(){e[$(this).data("type")]=$.trim($(this).text())}),$("#auto-playlists").children("a").each(function(){e[a($(this))]=$.trim($(this).find(".tooltip").text())}),e.searchPlaceholder=$.trim($("#material-one-middle input.material-search").attr("placeholder")),e.wmp=$.trim($("#playlists").prev(".nav-section-header").text()),t("connected",{quicklinks:e})}}if($("#primeplayerinjected").length)return window.addEventListener("message",e),void window.postMessage({type:"FROM_PRIMEPLAYER",msg:"cleanupCs"},location.href);ht&&R(S),v(i,"#playerSongInfo",500,"style"),v(O,"#playerSongInfo",250),v(r,"#time_container_current"),v(m,"#music-content",1e3),v(p,"#queueContainer",1e3);var y="#player > div.material-player-middle > [data-id='";h("class disabled",y+"play-pause']","player-playing",c,500),h("class disabled",y+"rewind']","player-rewind",l),h("class disabled",y+"forward']","player-forward",l),h("title style disabled",y+"repeat']","player-repeat",d,250),h("class style disabled",y+"shuffle']","player-shuffle",f),h("aria-valuenow","#material-vslider","player-volume"),$("#music-content,#queueContainer").on("DOMSubtreeModified",".song-row td[data-col='rating']",function(){var e=$(this),i=!!e.closest("#queueContainer").length;if(!i&&X||i&&J){var n,a=s(this),r=e.closest(".song-row").data("index"),o=0;i?n=J:(o=x(e),n=X[o]),n&&n[r]!=a&&(n[r]=a,t("player-listrating",{index:r,cluster:o,rating:a,controlLink:i?"#/ap/queue":location.hash}))}}),$(window).on("hashchange",function(){X=J=null,Z=null,R(rt),ot=!1,clearTimeout(K),clearTimeout(W)}),$("#playerSongInfo").on("click",".rating-container > *[data-rating]",function(t){t.clientX&&(ut=k(this)?0:s(this))}),$("#music-content,#queueContainer").on("mouseup",".song-row td[data-col='rating'] ul.rating-container li[data-rating]",function(){var e=$(this);t("rated",{song:D(e.closest(".song-row"),!0),rating:e.hasClass("selected")?0:s(this)})}),window.addEventListener("message",E),$("<script id='primeplayerinjected'><\/script>").attr("src",vt("js/injected.js")).appendTo("head");var b;b=setInterval(g,500)}function E(t){if(t.source==window&&"FROM_PRIMEPLAYER"==t.data.type&&t.data.msg)switch(t.data.msg){case"plSongRated":$("#music-content,#queueContainer").find(".song-row[data-index='"+t.data.index+"']").find("td[data-col='rating']").trigger("DOMSubtreeModified");case"plSongStarted":case"plSongError":ot=!1,$.isFunction(Z)&&Z(),Z=null;break;case"cleanupCs":Q.disconnect(),w(),window.postMessage({type:"FROM_PRIMEPLAYER",msg:"cleanupCsDone"},location.href)}}function T(t,e){window.postMessage({type:"FROM_PRIMEPLAYER",command:t,options:e},location.href)}function I(e){document.hidden&&!at&&(t("needActiveTab",at=$.now()),rt=e)}function R(e){at&&e==rt&&(t("restoreActiveTab",at),at=null,rt=null)}function P(t,e,i){return t.scrollIntoView(i),I(e),setTimeout(e,100)}function q(t,e){function i(){var n,a,s=r.find(".song-row");s.first().data("index")>e.index?(n=s[0],a=!0):s.last().data("index")<e.index&&(n=s.last()[0],a=!1),n?W=P(n,i,a):(T(t,e),R(i))}var n="#/ap/queue"==e.link;if(n||location.hash==e.link){var a="#music-content";n&&(a="#queueContainer",$("#queueContainer").is(":visible")||T("openQueue"));var r=$(a);e.cluster&&(r=$(r.find(ft)[e.cluster-1])),r=r.find(".song-table > tbody").filter(L(r)),!r.length||e.index>r.data("count")-1||(ot=!0,i())}}function _(t){return!(t!=pt&&t.indexOf("im/")&&t.indexOf("st/")&&t.indexOf("sm/")&&t.indexOf("situations/"))}function A(t){var e=t.substr(t.indexOf("/")+1),i=t.substr(0,t.indexOf("/"));return!!$(".material-card[data-id='"+e+"'][data-type='"+i+"']").length&&(G=pt,T("clickCard",{id:e}),!0)}function F(t,e){n(t)?e&&e():t==pt?$("#queueContainer").is(":visible")?e&&e():(V=e,G=pt,T("openQueue")):(V=e,t.indexOf("st/")&&t.indexOf("sm/")&&t.indexOf("situations/")?(G=t.indexOf("im/")?t:pt,location.hash="/"+t):A(t)||F("rd",function(){V=e,A(t)||(V=null,e&&e(!0))}))}function D(t,i){var n=t.find("td[data-col='title'] .column-content");n[0]||(n=t.find("td[data-col='song-details'] .song-title"));var a=t.find("td[data-col='artist']"),s=t.find("td[data-col='album']"),o={title:$.trim(n.text()),artist:$.trim(a.text()),album:$.trim(s.text())},l=$.trim(t.find("td[data-col='duration']").text());if(/^\d\d?(\:\d\d)*$/.test(l)&&(o.duration=l),!i){o.index=t.data("index"),o.cover=r(t.find("td[data-col='title'],td[data-col='song-details']").find(".column-content img"));var c=a.data("matchedId")||"";(o.artist||c)&&(o.artistLink="artist/"+e(c)+"/"+e(o.artist));var d=s.data("matchedId")||"";(d||o.album)&&(o.albumLink="album/"+e(d)+"/"+e(s.data("albumArtist")||"")+"/"+e(o.album))}return o}function U(t,e,i,n){function a(){var o=[],l=null,c=e.find(".material-card");if(c.slice(0,i).each(function(){var e=$(this);l=this;var i=c.index(e);if(!(i<=s)){var n=t(e);n&&(n.index=i,o.push(n),s=i)}}),!n)return o;r&&!o.length||(n(o,r),r=!0),l&&(void 0===i||s+1<i)?K=P(l,a,!1):R(a)}var r=!1,s=-1;return a()}function B(){var e=[];$("#playlists").children("a").each(function(){e.push({title:$.trim($(this).find(".tooltip").text()),titleLink:a($(this))})}),t("player-navigationList",{type:"playlistsList",link:"wmp",list:e,empty:!e.length})}function N(t){var e=t.indexOf("/");switch(e>0&&(t=t.substring(0,e)),t){case"artists":case"genres":case"srar":case"sarrar":return"albumContainers";case"now":case"albums":case"artist":case"wta":case"wnr":case"sar":case"tg":case"sral":case"srp":case"saral":case"ar":return"playlistsList";default:return"playlist"}}function j(t){var e,i=L(t),n=t.find(".song-table").filter(i);if(n.length)e="playlist";else{var r=t.find(".material-card").filter(i).first(),s=r.data("type");if(!s)return null;e="playlist"==N(s)?"playlistsList":"albumContainers",n=r.closest(".material-cluster,.cluster,.cluster-text-protection")}var o=gt[e](n,n.hasClass("cluster-text-protection")?100:10);return o.length?{list:o,type:e,header:$.trim(t.find(".header .cluster-title,.header .title,.recommended-header,.top-tracks-header").filter(i).text())||$.trim(t.find(".section-header").filter(i).text()),moreLink:t.hasClass("has-more")?a(t,!0):null,cluster:x(t)}:null}function Y(e){var i=$("#music-content");e.type="mixed",e.lists=[],e.moreText=$.trim(i.find("div .header .more:visible").first().text()),e.header=$.trim($("#header-tabs-container .header-tab-title.selected:visible").text())||$.trim($("#material-breadcrumbs .tab-text:visible").text())||$.trim($("#header-tabs-container .genre-dropdown-title .dropdown-title-text:visible").text())||$.trim($("#music-content .material-detail-view .artist-details .name:visible").text()),i.find(ft).addBack().each(function(){var t=$(this);if("situations"!=t.data("type")){var i=j(t);i&&e.lists.push(i)}}),e.empty=!e.lists.length,t("player-navigationList",e)}function z(e,i){F(e,function(n){function a(){r.error=!0,t("player-navigationList",r)}var r={link:e,controlLink:location.hash};if(n)a();else if("now"!=e&&"wnr"!=e&&"wms"!=e&&e.indexOf("artist/")&&e.indexOf("sr/")&&e.indexOf("wtc")&&e.indexOf("wms/")){var s=_(e),o=N(e);if(s||o==N(location.hash.substr(2))){r.type=o;var l="#music-content";s&&(l="#queueContainer",r.controlLink="#/ap/queue"),gt[o]($(l).find(".material-cluster,.material-card-grid,.song-table").first(),void 0,function(e,i){r.list=e,r.update=i,r.empty=!e.length,t("player-navigationList",r)},i)}else a()}else Y(r)})}function H(t,e){function i(){var e=$("#music-content .song-row");if(e.length){if(!n){if(e[0]&&0!==e.first().data("index"))return void(K=P(e[0],i,!0));n=!0}var a=!1;e.each(function(){var e=D($(this));if(o(e,t))return a=!0,T("resumePlaylistSong",{index:e.index,position:t.position}),!1});var r=a||e.last();!a&&r[0]&&r.data("index")<r.parent().data("count")-1?K=P(r[0],i,!1):R(i)}}if(!e){var n=!1;i()}}var Q,V,G,X,J,K,W,Z,tt,et,it,nt,at,rt,st=[],ot=!1,lt=!1,ct=!1,dt=-1,ut=-1,ft=".cluster,.genre-stations-container,.cluster-text-protection",pt="ap/queue",mt=chrome.i18n.getMessage,vt=chrome.runtime.getURL,ht=!1,gt={playlistsList:function(t,e,i,n){return U(function(t){var e=t.data("id");if(n&&e.substr(1).indexOf("/")<0)return null;var i={};if(i.titleLink=a(t),!i.titleLink)return null;i.cover=r(t.find(".image-wrapper img")),i.title=$.trim(t.find(".title").text());var s=t.find(".sub-title");return i.subTitle=$.trim(s.text()),i.subTitleLink=a(s),i},t,e,i)},playlist:function(t,e,i){function n(){r?J=o:X[a]=o;var u=t.find(".song-row");if(!c&&l&&i&&u[0]&&0!==u.first().data("index"))return void(K=P(u[0],n,!0));var f=[],p=null;if(u.slice(0,e).each(function(){if(ot)return!1;var t=$(this);if(p=this,!(t.data("index")<=d)){var e=D(t);t.find(".song-indicator").length&&(e.current=!0),e.rating=s(t.find("td[data-col='rating']")[0]),d=e.index,o.push(e.rating),f.push(e)}}),!i)return f;c&&!f.length||(i(f,c),c=!0),l&&d+1<l&&(void 0===e||d+1<e)?ot?Z=n:(p&&(r?J=null:X[a]=null,p.scrollIntoView(!1),I(n)),K=setTimeout(n,150)):R(n)}var a,r=!!t.closest("#queueContainer").length,o=[];r||(X=X||[],a=x(t));var l=t.find("[data-count]").data("count"),c=!1,d=-1;if(!i)return n();ot=!1,n()},albumContainers:function(t,e,i){return U(function(t){var e=a(t);return e?{cover:r(t.find(".image-inner-wrapper img")),title:$.trim(t.find(".details .title").text()),link:e}:null},t,e,i)}};Q=chrome.runtime.connect({name:"googlemusic"}),Q.onDisconnect.addListener(w),Q.onMessage.addListener(function(t){switch(t.type){case"execute":"startPlaylistSong"==t.command||"ratePlaylistSong"==t.command?q(t.command,t.options):T(t.command,t.options);break;case"getNavigationList":clearTimeout(K),X=null,"wmp"==t.link?B():z(t.link,t.omitUnknownAlbums);break;case"selectLink":F(t.link);break;case"startPlaylist":F(t.link,function(e){e||_(t.link)||T("startPlaylist")});break;case"resumeLastSong":F(t.albumLink,H.bind(window,t));break;case"lyrics":d(t.result,t.providers,t.srcUrl);break;case"feelingLucky":F("now",T.bind(window,"feelingLucky"));break;case"connected":S();break;case"connectedIndicator":t.show?l():c();break;case"lyricsState":t.enabled?h(t.fontSize,t.width,t.opacity):v(),lt=t.autoReload;break;case"starRatingMode":g(t.value);break;case"setConfirmClose":b(t.confirmClose);break;case"alreadyConnected":Q.disconnect(),Q=null}})});