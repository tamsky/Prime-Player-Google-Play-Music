/**
 * @author Sven Ackermann (svenrecknagel@gmail.com)
 * @license BSD license
 */
chrome.runtime.getBackgroundPage(function(t){function e(t,e,i){$("#"+t).nextUntil("*:not(."+(i||"sub")+")").prop("disabled",!e)}function i(){var i=t.isScrobblingEnabled();$("#showScrobbledIndicator").prop("disabled",!i),e("scrobble",i)}function n(){e("linkRatings",w.linkRatings&&P.lastfmSessionName)}function o(){var t=!w.toast&&!w.toastOnPlayPause;$("#toastIfMpOpen,#toastNotIfGmActive,#toastDuration").prop("disabled",t),$("#toastIfMpMinimized").prop("disabled",t||!w.toastIfMpOpen),$("#toastUseMpStyle").prop("disabled",t||!P.notificationsEnabled),e("toastUseMpStyle",!t&&!w.toastUseMpStyle,"sub2")}function a(t,e,i){$("pp-select#"+t+",pp-select[from='#"+t+"']").each(function(){this.setDisabled(e,i)})}function s(e){var o,s;$("#scrobble,#linkRatings,#showLovedIndicator").prop("disabled",!e),a("toastClick","loveUnloveSong",!e),i(),n();var r=$("#lastfmStatus"),c=r.find("a");e?(o=function(){r.find(".status").hide(),t.lastfmLogout()},s=S("logout"),c.text(e).attr("href","http://last.fm/user/"+e).removeClass("disconnected")):(o=t.lastfmLogin,s=S("connect"),c.text(S("disconnected")).removeAttr("href").addClass("disconnected")),$("#lastfmlogin").text(s).off().on("tap",o)}function r(t){T.toggleClass("notifDisabled",!t),o()}function c(e){var i=Math.floor((e||0)-$.now()/1e3);i>0?$("#timerStatus").show().find(">div").text(S("setting_timerAction_"+P.timerAction)+" in "+t.toTimeString(i)):($("#timerStatus").hide(),clearInterval(I))}function l(t){clearInterval(I),t&&(I=setInterval(c.bind(window,t),1e3)),c(t),$("#startTimer,#timerMinutes,#timerNotify,#timerPreNotify,#timerAction").prop("disabled",0!==t),$(".stopTimer").prop("disabled",!t)}function d(){var e=[""].concat(t.getQuicklinks()).map(function(e){return{text:t.getTextForQuicklink(e),value:e}});$("#coverClickLink,#titleClickLink").each(function(){this.setItems(e)})}function f(t,e,i){var n=$("#confirmDialog");$("p",n).text(t),$("[dialog-dismiss]",n).toggle(!1!==e),n.off().on("iron-overlay-closed",function(t){t.detail.confirmed?$.isFunction(e)&&e():$.isFunction(i)&&i()}),n[0].open()}function p(){var e,i=$("pp-lyricsproviders")[0],n={},o=t.lyricsProviders;P.w("lyricsProviders",function(t){e=t,i.activeProviders=e,$("#lyrics").prop("disabled",!e.length),$("#lyricsAutoNext").prop("disabled",e.length<2),!e.length&&P.lyrics&&(P.lyrics=!1)},k);var a=o.available.map(function(t){function a(){var i=e.indexOf(t);i<0?e.push(t):e.splice(i,1),P.lyricsProviders=e.slice()}var s=o[t];return s.checkPermission(function(o){o?n[t]=a:(e.indexOf(t)>=0&&a(),n[t]=function(){f(S("lyricsAlert",s.getUrl()),function(){s.requestPermission(function(e){e?(a(),n[t]=a):i.resetView()})},function(){i.resetView()})})}),{name:t,homepage:s.getHomepage(),url:s.getUrl()}});i.providers=a,$("pp-lyricsproviders").on("toggled",function(t){var e=n[t.detail.provider];$.isFunction(e)&&e()}).on("moved",function(t){var i=t.detail.provider,n=e.indexOf(i);e.splice(n,1),e.splice(t.detail.up?n-1:n+1,0,i),P.lyricsProviders=e.slice()})}function u(){var t=$("#timerPreNotify"),e=60*$("#timerMinutes").val();t.attr("max",e),t.val()>e&&t.val(e)}function m(){$("#timerStatus h2").text(S("timerActive"));var e=$("#timerMinutes").off().on("value-changed",u),i=$("#timerNotify").off(),n=$("#timerPreNotify").off().on("value-changed",function(t){var e=parseFloat(t.detail.value);!$.isNumeric(e)||e<this.min?this.value=this.min:e>this.max&&(this.value=this.max)}),o=$("#timerAction").off();$("#startTimer").text(S("startTimer")).click(function(){var a=parseFloat(e.val());a&&(P.timerMinutes=a,P.timerAction=o.val(),P.timerNotify=i.val(),P.timerPreNotify=parseFloat(n.val()),P.timerEnd=$.now()/1e3+60*a,t.startSleepTimer())}),$(".stopTimer").text(S("stopTimer")).click(t.clearSleepTimer),u()}function g(){var s={iconClickChanged:function(){var t="0"==$("#iconDoubleClickTime").prop("disabled",!w.iconClickAction0).val();[1,2,3].forEach(function(e){var i=!w["iconClickAction"+(e-1)];i&&(w["iconClickAction"+e]=""),$("#iconClickAction"+e).prop("disabled",i||t)})},saveLastPosition:function(t){a("iconClickConnectAction","resumeLastSong",!t)},subsEnabled:function(t,i,n){e(n,t)},starRatingMode:function(e){T.toggleClass("star",e),T.toggleClass("thumbs",!e),$("#toastClick,pp-select[from='#toastClick']").each(function(){this.setText("rate-1",t.getCommandOptionText("rate-1")),this.setText("rate-5",t.getCommandOptionText("rate-5"))})},layoutHint:function(){var t="panel"==w.miniplayerType||"detached_panel"==w.miniplayerType;$("#miniplayerType .hint-trigger").toggle(t),$("#layout .hint-trigger").toggle(t&&"hbar"==w.layout)},toast:o,scrobble:i,linkRatings:n,lyrics:function(){e("lyrics",P.lyrics),$("#lyricsWidth").prop("disabled",!P.lyrics||!w.lyricsInGpm),a("toastClick","openLyrics",!P.lyrics)},timerMinutes:u,optionsMode:function(t){T.removeClass("f-beg f-adv f-exp").addClass("f-"+t)}},r={bundle:function(t,e){return chrome.i18n.getMessage("setting_"+e+"_"+t)},commandOptionText:t.getCommandOptionText,connectActionText:function(t){return S(t?t:"openPopup")},playlistEndActionText:function(e){return e.indexOf("ap/")?t.getCommandOptionText(e):S("ob_startsugg",t.getTextForQuicklink(e))}};$("pp-select").each(function(){var t=this.from?$(this.from)[0]:this,e=t.options.split(","),i=r[t.getoptionstext],n=e.map(function(t){return{text:i(t,this.id),value:t}},this);this.setItems(n)}),$(".pp-option").each(function(){var t=this.local?P:w,e=this;t.w(this.id,function(t){e.value=t},k),$(this).on("value-changed",function(i){var n=i.detail.value;"number"==e.type?(n=parseFloat(n),$.isNumeric(e.min)&&n<e.min||$.isNumeric(e.max)&&n>e.max?e.value=t[e.id]:t[e.id]=n):t[e.id]=n}),this.listened?t.al(this.id,s[this.listener],k):this.watched&&t.w(this.id,s[this.listener],k)})}function v(e,i){function n(a){$.get(a).done(function(i,a,s){i.forEach(function(t){var e=t.tag_name;!t.prerelease&&/^(\d+\.)*\d+$/.test(e)&&o.push({v:e,d:$.trim(t.body),p:new Date(t.published_at).getTime()})});var r=s.getResponseHeader("Link");if(r){var c=r.match(/^.*<([^>]+)>; rel\=\"next\".*$/);if(c&&(c=c[1]),c)return n(c)}o.sort(function(e,i){return t.compareVersions(i.v,e.v)});var l={};l[C]=o,chrome.storage.local.set(l),e(o)}).fail(function(t,n,o){e(i)})}var o=[];n("https://api.github.com/repos/svenackermann/Prime-Player-Google-Play-Music/releases")}function h(t){var e=$(t).attr("class"),i=e.indexOf("v-")+2;if(i<0)return null;var n=e.indexOf(" ",i);return e.substring(i,n<0?e.length:n)}function b(e){var i="https://github.com/svenackermann/Prime-Player-Google-Play-Music/releases/",n=$("#changelog");if(n.children("a").attr("href",i),e.length&&(e.forEach(function(t){var e=$("<div>").addClass("v-"+t.v).appendTo(n),o=$("<h3>").appendTo(e);$("<a>").attr("target","_blank").attr("href",i+t.v).text("Version "+t.v).appendTo(o),o.append(" ("+new Date(t.p).toLocaleDateString()+")");var a=!1;t.d.split("\n").forEach(function(t){if(t=$.trim(t),t.indexOf("* "))a&&(e=e.parent(),a=!1),e.append(t+"<br/>");else{a||(e=$("<ul>").appendTo(e),a=!0),t=t.substr(2);var i=t.match(/^([FIBV\/]+)\:.*$/);i&&(i=i[1].replace(/\//g," "),t=$.trim(t.substr(t.indexOf(":")+1))),$("<li>").addClass(i||"").text(t).appendTo(e)}})}),n.show()),n.children("pp-cltoggle").on("toggled",function(t){n.toggleClass(this.type,t.detail.active)}),t.previousVersion){var o={};$("[class*='v-']").each(function(){var e=h(this);if(t.isNewerVersion(e)){$(this).addClass("newFeature");var i=$(this).parents("pp-tab").attr("id");i&&"tabInfo"!=i&&(o[i]=o[i]?o[i]+1:1)}});var a=$("pp-tabs")[0];a.badges=o,a.selectedTab="tabInfo",t.updateInfosViewed()}}function x(){var t="Options";$("#exportSettings").on("tap",function(){var e=JSON.stringify({version:A,settings:w.getAll()},null,2),i=$("#downloadLink");i.attr("href","data:application/json;charset=utf-8,"+encodeURIComponent(e)),i[0].click(),M.event(t,"export")}).text(S("exportSettings"));var e=new FileReader,i=$("#importInput");i.change(function(){this.files&&this.files[0]&&(e.onload=function(e){function n(){var e=w.importProperties(o.settings);e.length&&(M.event(t,"import-unimported"),f(S("importSettingsUnimported","\n\n"+e.join("\n")),!1)),M.event(t,"import-finish")}var o;i.val("");try{if(!(o=JSON.parse(e.target.result))||!o.version||!o.settings)throw"mandatory field missing";o.version!=A?(M.event(t,"import-mismatch"),f(S("importSettingsVersionMismatch"),n,function(){M.event(t,"import-cancel")})):n()}catch(e){f(S("importSettingsError"),!1),M.event(t,"import-error")}},e.readAsText(this.files[0]))}),$("#importSettings").on("tap",function(){M.event(t,"import-start"),i[0].click()}).text(S("importSettings")),$("#resetSettings").on("tap",function(){f(S("resetSettingsConfirm"),function(){w.reset(),P.reset(),M.event(k,"reset")})}).text(S("resetSettings"))}function y(){chrome.storage.local.get(C,function(e){var i=e[C];!i||!i.length||t.compareVersions(i[0].v,A)<0?v(b,i||[]):b(i)})}var k="options",C="releases",T=$("iron-pages"),S=chrome.i18n.getMessage,w=t.settings,P=t.localSettings,A=chrome.runtime.getManifest().version,M=initGA(w,k);chrome.runtime.onMessage.addListener(function(t){function e(t,e){$("#"+t).show(),Polymer.dom($("paper-tooltip[for='"+t+"']")[0]).textContent=e}if("lastfmStatusChanged"==t.type){var i=$("#lastfmStatus");i.children(".status").hide(),!1===t.status?i.children(".loader").show():!0===t.status?e("lastfmSuccess",S("lastfmConnectSuccess")):"string"==typeof t.status&&e("lastfmFailure",t.status)}});var I;$(function(){$("#confirmDialog [dialog-confirm]").text(S("dialogOk")),$("#confirmDialog [dialog-dismiss]").text(S("dialogCancel")),$("head > title").text(S("options")+" - "+S("extTitle")),$("#legendIc").text(S("legendIc")).after(S("legendIcHint")),g(),$("#shortcutsLink").text(S("configShortcuts")).click(function(){chrome.tabs.create({url:"chrome://extensions/configureCommands"})}),$("#iconClickActionTitle").text(S("iconClickActionTitle")),$("pp-select[id^='iconClickAction']").each(function(){this.setText("",S("openPopup"))}),$("#startupAction")[0].setText("",S("command_")),$("#miniplayerType .hint-content a").text("chrome://flags").attr("tabindex","0").click(function(){chrome.tabs.create({url:"chrome://flags/#enable-panels"})}),$("#notificationDisabledWarning div").text(S("notificationsDisabled")),$("#lastfmStatus").find("span").text(S("lastfmUser")),p(),m(),P.w("lastfmSessionName",s,k),P.w("notificationsEnabled",r,k),P.w("timerEnd",l,k),P.w("quicklinks",d,k),P.w("syncSettings",function(t){$("body").toggleClass("syncenabled",t)},k),x(),y(),$("#credits").on("click","[data-network]",function(){var t=$(this);M.social(t.data("network"),t.data("action")||"show",t.attr("href")||"-")})}),$(window).on("unload",function(){w.ral(k),P.ral(k)})});